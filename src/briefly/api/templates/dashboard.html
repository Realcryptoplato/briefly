<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Briefly 3000</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="dashboard()">
        <!-- Header -->
        <div class="mb-8 flex items-start justify-between">
            <div>
                <h1 class="text-4xl font-bold text-cyan-400">Briefly 3000</h1>
                <p class="text-gray-400 mt-2">LLM-native media curation ‚Ä¢ Powered by Grok + Gemini</p>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs px-2 py-1 rounded-full" :class="apiStatus.grok ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'">
                    Grok <span x-text="apiStatus.grok ? '‚úì' : '‚úó'"></span>
                </span>
                <span class="text-xs px-2 py-1 rounded-full" :class="apiStatus.gemini ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'">
                    Gemini <span x-text="apiStatus.gemini ? '‚úì' : '‚úó'"></span>
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Sources Panel -->
            <div class="lg:col-span-1 space-y-6">
                <!-- X Sources -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <span class="text-2xl">ùïè</span> X Accounts
                        <span class="text-sm text-gray-500 font-normal">(<span x-text="sources.x?.length || 0"></span>)</span>
                        <span class="ml-auto text-xs text-cyan-400">via Grok</span>
                    </h2>

                    <form @submit.prevent="addXSource" class="mb-4">
                        <div class="flex gap-2">
                            <input
                                type="text"
                                x-model="newXSource"
                                placeholder="@username"
                                class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-cyan-500"
                            >
                            <button type="submit" :disabled="loading" class="bg-cyan-600 hover:bg-cyan-500 px-4 py-2 rounded text-sm font-medium disabled:opacity-50">
                                Add
                            </button>
                        </div>
                        <p x-show="xError" x-text="xError" class="text-red-400 text-sm mt-2"></p>
                    </form>

                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        <template x-for="source in sources.x" :key="source">
                            <div class="flex items-center justify-between bg-gray-700 rounded px-3 py-2 text-sm">
                                <span class="font-medium">@<span x-text="source"></span></span>
                                <button @click="removeSource('x', source)" class="text-red-400 hover:text-red-300">‚úï</button>
                            </div>
                        </template>
                        <p x-show="!sources.x?.length" class="text-gray-500 text-sm">No X accounts yet</p>
                    </div>

                    <!-- Quick Test -->
                    <button @click="testXSummary" :disabled="testingX" class="mt-4 w-full bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded text-sm">
                        <span x-show="testingX">Testing...</span>
                        <span x-show="!testingX">üß™ Test X Summary</span>
                    </button>
                </div>

                <!-- YouTube Sources -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <span class="text-2xl text-red-500">‚ñ∂</span> YouTube
                        <span class="text-sm text-gray-500 font-normal">(<span x-text="sources.youtube?.length || 0"></span>)</span>
                        <span class="ml-auto text-xs text-cyan-400">via Gemini</span>
                    </h2>

                    <form @submit.prevent="addYTSource" class="mb-4">
                        <div class="flex gap-2">
                            <input
                                type="text"
                                x-model="newYTSource"
                                placeholder="@channel or video URL"
                                class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-red-500"
                            >
                            <button type="submit" :disabled="loading" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded text-sm font-medium disabled:opacity-50">
                                Add
                            </button>
                        </div>
                        <p x-show="ytError" x-text="ytError" class="text-red-400 text-sm mt-2"></p>
                    </form>

                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        <template x-for="source in sources.youtube" :key="source.identifier || source">
                            <div class="flex items-center justify-between bg-gray-700 rounded px-3 py-2 text-sm">
                                <div class="truncate flex-1 mr-2">
                                    <span class="font-medium" x-text="source.name || source.identifier || source"></span>
                                </div>
                                <button @click="removeSource('youtube', source.identifier || source)" class="text-red-400 hover:text-red-300 flex-shrink-0">‚úï</button>
                            </div>
                        </template>
                        <p x-show="!sources.youtube?.length" class="text-gray-500 text-sm">No YouTube channels yet</p>
                    </div>
                </div>

                <!-- Podcast Sources -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üéôÔ∏è</span> Podcasts
                        <span class="text-sm text-gray-500 font-normal">(<span x-text="sources.podcasts?.length || 0"></span>)</span>
                        <span class="ml-auto text-xs text-cyan-400">via Gemini</span>
                    </h2>

                    <form @submit.prevent="addPodcast" class="mb-4">
                        <div class="space-y-2">
                            <input
                                type="text"
                                x-model="newPodcastName"
                                placeholder="Podcast name"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-purple-500"
                            >
                            <input
                                type="text"
                                x-model="newPodcastUrl"
                                placeholder="RSS feed URL or audio URL"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-purple-500"
                            >
                            <button type="submit" :disabled="loading" class="w-full bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded text-sm font-medium disabled:opacity-50">
                                Add Podcast
                            </button>
                        </div>
                        <p x-show="podcastError" x-text="podcastError" class="text-red-400 text-sm mt-2"></p>
                    </form>

                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        <template x-for="podcast in sources.podcasts" :key="podcast.name">
                            <div class="flex items-center justify-between bg-gray-700 rounded px-3 py-2 text-sm">
                                <div class="truncate flex-1 mr-2">
                                    <span class="font-medium" x-text="podcast.name"></span>
                                    <span class="text-xs text-gray-500 block truncate" x-text="podcast.feed_url || podcast.audio_url"></span>
                                </div>
                                <button @click="removePodcast(podcast.name)" class="text-red-400 hover:text-red-300 flex-shrink-0">‚úï</button>
                            </div>
                        </template>
                        <p x-show="!sources.podcasts?.length" class="text-gray-500 text-sm">No podcasts yet</p>
                    </div>

                    <!-- Test Audio URL -->
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <p class="text-xs text-gray-400 mb-2">Quick test: paste any podcast audio URL</p>
                        <div class="flex gap-2">
                            <input
                                type="text"
                                x-model="testAudioUrl"
                                placeholder="https://...mp3"
                                class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs"
                            >
                            <button @click="testPodcastSummary" :disabled="testingPodcast" class="bg-purple-600 hover:bg-purple-500 px-3 py-1 rounded text-xs">
                                Test
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Cost Estimate -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-2">Estimated Cost per Briefing</h3>
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between">
                            <span>X (<span x-text="sources.x?.length || 0"></span> accounts)</span>
                            <span class="text-cyan-400">~$0.003</span>
                        </div>
                        <div class="flex justify-between">
                            <span>YouTube (<span x-text="sources.youtube?.length || 0"></span> channels)</span>
                            <span class="text-cyan-400">~$<span x-text="((sources.youtube?.length || 0) * 0.05).toFixed(2)"></span></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Podcasts (<span x-text="sources.podcasts?.length || 0"></span>)</span>
                            <span class="text-cyan-400">~$<span x-text="((sources.podcasts?.length || 0) * 0.05).toFixed(2)"></span></span>
                        </div>
                        <div class="flex justify-between pt-2 border-t border-gray-700 font-medium">
                            <span>Total</span>
                            <span class="text-green-400">~$<span x-text="(0.003 + (sources.youtube?.length || 0) * 0.05 + (sources.podcasts?.length || 0) * 0.05).toFixed(2)"></span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Briefing Panel -->
            <div class="lg:col-span-2">
                <div class="bg-gray-800 rounded-lg p-6">
                    <!-- Header with Generate Options -->
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold flex items-center gap-2">
                            <span class="text-2xl">üìã</span> Briefing
                        </h2>
                        <div class="flex items-center gap-2">
                            <!-- Time Range -->
                            <select x-model="hoursBack" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                                <option value="12">Last 12h</option>
                                <option value="24">Last 24h</option>
                                <option value="48">Last 48h</option>
                                <option value="72">Last 72h</option>
                            </select>

                            <!-- Focus (optional) -->
                            <input
                                type="text"
                                x-model="briefingFocus"
                                placeholder="Focus (optional)"
                                class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm w-32"
                            >

                            <!-- Generate Buttons -->
                            <button
                                @click="generateQuickBriefing"
                                :disabled="generating"
                                class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-sm font-medium disabled:opacity-50"
                                title="X accounts only - fastest"
                            >
                                ‚ö° Quick
                            </button>
                            <button
                                @click="generateFullBriefing"
                                :disabled="generating"
                                class="bg-cyan-600 hover:bg-cyan-500 px-4 py-2 rounded text-sm font-medium disabled:opacity-50 flex items-center gap-2"
                            >
                                <span x-show="generating" class="animate-spin">‚ü≥</span>
                                <span x-text="generating ? 'Generating...' : 'üöÄ Full Briefing'"></span>
                            </button>
                        </div>
                    </div>

                    <!-- Source Selection -->
                    <div class="mb-6 p-4 bg-gray-700/50 rounded-lg">
                        <p class="text-sm text-gray-400 mb-3">Include in briefing:</p>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" x-model="includeX" class="rounded bg-gray-600 border-gray-500">
                                <span class="text-sm">ùïè X Accounts (<span x-text="sources.x?.length || 0"></span>)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" x-model="includeYouTube" class="rounded bg-gray-600 border-gray-500">
                                <span class="text-sm">‚ñ∂ YouTube (<span x-text="sources.youtube?.length || 0"></span>)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" x-model="includePodcasts" class="rounded bg-gray-600 border-gray-500">
                                <span class="text-sm">üéôÔ∏è Podcasts (<span x-text="sources.podcasts?.length || 0"></span>)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Generation Progress -->
                    <div x-show="generating" class="mb-6 p-4 bg-gradient-to-r from-cyan-900/30 to-purple-900/30 rounded-lg border border-cyan-700/30">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
                            <div>
                                <div class="font-medium text-cyan-200" x-text="generationStep"></div>
                                <div class="text-xs text-gray-400" x-text="generationDetail"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Display -->
                    <div x-show="generationError" class="mb-6 p-4 bg-red-900/30 rounded-lg border border-red-700/50">
                        <p class="text-red-300" x-text="generationError"></p>
                    </div>

                    <!-- Briefing Content -->
                    <template x-if="currentBriefing">
                        <div>
                            <!-- Metadata -->
                            <div class="text-sm text-gray-400 mb-4 flex flex-wrap items-center gap-4">
                                <span class="flex items-center gap-1">
                                    üïê <span x-text="new Date(currentBriefing.generated_at).toLocaleString()"></span>
                                </span>
                                <span x-show="currentBriefing.focus" class="flex items-center gap-1">
                                    üéØ Focus: <span class="text-cyan-400" x-text="currentBriefing.focus"></span>
                                </span>
                                <span x-show="currentBriefing.stats?.x_sources" class="flex items-center gap-1">
                                    ùïè <span x-text="currentBriefing.stats.x_sources"></span> accounts
                                </span>
                                <span x-show="currentBriefing.stats?.youtube_sources" class="flex items-center gap-1">
                                    ‚ñ∂ <span x-text="currentBriefing.stats.youtube_sources"></span> channels
                                </span>
                            </div>

                            <!-- Executive Summary -->
                            <div class="mb-8">
                                <h3 class="text-lg font-semibold mb-3 text-cyan-400">Executive Summary</h3>
                                <div class="bg-gray-700/50 rounded-lg p-4 prose prose-invert prose-sm max-w-none">
                                    <div x-html="formatMarkdown(currentBriefing.summary)"></div>
                                </div>
                            </div>

                            <!-- Sections -->
                            <template x-for="section in currentBriefing.sections" :key="section.title">
                                <div class="mb-8">
                                    <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"
                                        :class="section.platform === 'x' ? 'text-gray-300' : section.platform === 'youtube' ? 'text-red-400' : 'text-purple-400'">
                                        <span x-text="section.platform === 'x' ? 'ùïè' : section.platform === 'youtube' ? '‚ñ∂' : 'üéôÔ∏è'"></span>
                                        <span x-text="section.title"></span>
                                    </h3>

                                    <!-- X Section -->
                                    <template x-if="section.platform === 'x'">
                                        <div class="bg-gray-700/50 rounded-lg p-4">
                                            <div class="prose prose-invert prose-sm max-w-none" x-html="formatMarkdown(section.content)"></div>
                                            <div class="mt-3 pt-3 border-t border-gray-600">
                                                <p class="text-xs text-gray-500">Accounts: <span x-text="section.accounts?.join(', ')"></span></p>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- YouTube Section -->
                                    <template x-if="section.platform === 'youtube'">
                                        <div class="space-y-4">
                                            <template x-for="video in section.videos" :key="video.url">
                                                <div class="bg-gray-700/50 rounded-lg p-4">
                                                    <div class="flex items-start gap-4">
                                                        <a :href="video.url" target="_blank" class="flex-shrink-0">
                                                            <img :src="getYouTubeThumbnail(video.url)" class="w-32 h-20 object-cover rounded" loading="lazy">
                                                        </a>
                                                        <div class="flex-1 min-w-0">
                                                            <h4 class="font-medium text-sm mb-1 line-clamp-1" x-text="video.title"></h4>
                                                            <p class="text-xs text-cyan-400 mb-2" x-text="video.channel"></p>
                                                            <p class="text-sm text-gray-300 line-clamp-3" x-text="video.summary?.substring(0, 200) + '...'"></p>
                                                            <div class="mt-2 flex gap-3">
                                                                <a :href="video.url" target="_blank" class="text-cyan-400 text-xs hover:underline">Watch ‚Üí</a>
                                                                <button @click="expandVideo(video)" class="text-purple-400 text-xs hover:underline">Full Summary</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>

                                    <!-- Podcast Section -->
                                    <template x-if="section.platform === 'podcast'">
                                        <div class="space-y-4">
                                            <template x-for="episode in section.episodes" :key="episode.url">
                                                <div class="bg-gray-700/50 rounded-lg p-4">
                                                    <div class="flex items-start gap-3">
                                                        <div class="w-12 h-12 bg-purple-900/50 rounded-lg flex items-center justify-center flex-shrink-0">
                                                            <span class="text-xl">üéß</span>
                                                        </div>
                                                        <div class="flex-1 min-w-0">
                                                            <h4 class="font-medium text-sm mb-1" x-text="episode.title"></h4>
                                                            <p class="text-xs text-purple-400 mb-2" x-text="episode.podcast_name"></p>
                                                            <p class="text-sm text-gray-300 line-clamp-3" x-text="episode.summary?.substring(0, 200) + '...'"></p>
                                                            <div class="mt-2 flex gap-3">
                                                                <a x-show="episode.url" :href="episode.url" target="_blank" class="text-cyan-400 text-xs hover:underline">Listen ‚Üí</a>
                                                                <button @click="expandPodcast(episode)" class="text-purple-400 text-xs hover:underline">Full Summary</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Stats Footer -->
                            <div class="mt-8 pt-4 border-t border-gray-700 text-xs text-gray-500 flex flex-wrap gap-4">
                                <span x-show="currentBriefing.stats?.x_summary_generated">‚úì X summary via Grok</span>
                                <span x-show="currentBriefing.stats?.youtube_summaries_generated">‚úì <span x-text="currentBriefing.stats.youtube_summaries_generated"></span> YouTube videos via Gemini</span>
                                <span x-show="currentBriefing.stats?.podcast_summaries_generated">‚úì <span x-text="currentBriefing.stats.podcast_summaries_generated"></span> podcasts via Gemini</span>
                            </div>
                        </div>
                    </template>

                    <!-- Empty State -->
                    <template x-if="!currentBriefing && !generating">
                        <div class="text-gray-500 text-center py-12">
                            <p class="text-4xl mb-4">ü§ñ</p>
                            <p class="mb-2">No briefings yet.</p>
                            <p class="text-sm">Add sources and click "Full Briefing" to get started!</p>
                        </div>
                    </template>
                </div>

                <!-- Previous Briefings -->
                <div x-show="briefings.length > 1" class="mt-6 bg-gray-800 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-gray-400 mb-3">Previous Briefings</h3>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="(b, idx) in briefings.slice(1, 6)" :key="b.id || idx">
                            <button
                                @click="loadBriefing(b)"
                                class="text-xs px-3 py-1 rounded bg-gray-700 hover:bg-gray-600"
                                x-text="new Date(b.generated_at).toLocaleDateString() + ' ' + new Date(b.generated_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})"
                            ></button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expanded Content Modal -->
        <div x-show="expandedContent" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/70" @click.self="expandedContent = null">
            <div class="bg-gray-800 rounded-lg w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold" x-text="expandedContent?.title || 'Content'"></h3>
                    <button @click="expandedContent = null" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="prose prose-invert prose-sm max-w-none" x-html="formatMarkdown(expandedContent?.summary || expandedContent?.content || '')"></div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <a x-show="expandedContent?.url" :href="expandedContent?.url" target="_blank" class="text-cyan-400 hover:underline">
                        View Original ‚Üí
                    </a>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-gray-500 text-sm">
            <span>Briefly 3000 ‚Ä¢ LLM-Native Architecture ‚Ä¢ Grok for X ‚Ä¢ Gemini for Media</span>
        </div>
    </div>

    <style>
        [x-cloak] { display: none !important; }

        .prose h1, .prose h2, .prose h3, .prose h4 {
            color: #e5e7eb;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .prose h1:first-child, .prose h2:first-child, .prose h3:first-child {
            margin-top: 0;
        }
        .prose p { margin-bottom: 0.75em; }
        .prose ul, .prose ol { margin-left: 1.5em; margin-bottom: 0.75em; }
        .prose li { margin-bottom: 0.25em; }
        .prose strong { color: #22d3ee; }
        .prose a { color: #22d3ee; }
        .prose blockquote {
            border-left: 3px solid #4b5563;
            padding-left: 1em;
            color: #9ca3af;
            font-style: italic;
        }
    </style>

    <script>
        function dashboard() {
            return {
                // Sources
                sources: { x: [], youtube: [], podcasts: [] },
                newXSource: '',
                newYTSource: '',
                newPodcastName: '',
                newPodcastUrl: '',
                xError: '',
                ytError: '',
                podcastError: '',
                loading: false,

                // Briefing generation
                generating: false,
                generationStep: '',
                generationDetail: '',
                generationError: null,
                hoursBack: '24',
                briefingFocus: '',
                includeX: true,
                includeYouTube: true,
                includePodcasts: true,

                // Briefings
                briefings: [],
                currentBriefing: null,

                // Testing
                testingX: false,
                testingPodcast: false,
                testAudioUrl: '',

                // Modal
                expandedContent: null,

                // API status
                apiStatus: { grok: false, gemini: false },

                async init() {
                    await this.loadSources();
                    await this.loadBriefings();
                    await this.checkApiStatus();
                },

                async checkApiStatus() {
                    try {
                        const grokResp = await fetch('/api/llm/test/grok');
                        this.apiStatus.grok = grokResp.ok;
                    } catch { this.apiStatus.grok = false; }

                    try {
                        const geminiResp = await fetch('/api/llm/test/gemini');
                        this.apiStatus.gemini = geminiResp.ok;
                    } catch { this.apiStatus.gemini = false; }
                },

                async loadSources() {
                    try {
                        const resp = await fetch('/api/sources');
                        const data = await resp.json();
                        // Normalize X sources to simple array
                        this.sources.x = (data.x || []).map(s => typeof s === 'string' ? s : s.identifier);
                        this.sources.youtube = data.youtube || [];
                        this.sources.podcasts = data.podcasts || [];
                    } catch (e) { console.error('Failed to load sources:', e); }
                },

                async loadBriefings() {
                    try {
                        const resp = await fetch('/api/briefings');
                        if (resp.ok) {
                            this.briefings = await resp.json();
                            if (this.briefings.length > 0) {
                                this.currentBriefing = this.briefings[0];
                            }
                        }
                    } catch (e) { console.error(e); }
                },

                loadBriefing(briefing) {
                    this.currentBriefing = briefing;
                },

                async addXSource() {
                    if (!this.newXSource.trim()) return;
                    this.loading = true;
                    this.xError = '';

                    try {
                        const resp = await fetch('/api/sources', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ platform: 'x', identifier: this.newXSource.trim() })
                        });

                        if (!resp.ok) {
                            const err = await resp.json();
                            this.xError = err.detail || 'Failed to add source';
                        } else {
                            this.newXSource = '';
                            await this.loadSources();
                        }
                    } catch (e) {
                        this.xError = 'Network error';
                    } finally {
                        this.loading = false;
                    }
                },

                async addYTSource() {
                    if (!this.newYTSource.trim()) return;
                    this.loading = true;
                    this.ytError = '';

                    try {
                        const resp = await fetch('/api/sources', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ platform: 'youtube', identifier: this.newYTSource.trim() })
                        });

                        if (!resp.ok) {
                            const err = await resp.json();
                            this.ytError = err.detail || 'Failed to add source';
                        } else {
                            this.newYTSource = '';
                            await this.loadSources();
                        }
                    } catch (e) {
                        this.ytError = 'Network error';
                    } finally {
                        this.loading = false;
                    }
                },

                async addPodcast() {
                    if (!this.newPodcastName.trim() || !this.newPodcastUrl.trim()) {
                        this.podcastError = 'Name and URL required';
                        return;
                    }
                    this.loading = true;
                    this.podcastError = '';

                    try {
                        const resp = await fetch('/api/sources/podcasts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.newPodcastName.trim(),
                                feed_url: this.newPodcastUrl.trim()
                            })
                        });

                        if (!resp.ok) {
                            const err = await resp.json();
                            this.podcastError = err.detail || 'Failed to add podcast';
                        } else {
                            this.newPodcastName = '';
                            this.newPodcastUrl = '';
                            await this.loadSources();
                        }
                    } catch (e) {
                        this.podcastError = 'Network error';
                    } finally {
                        this.loading = false;
                    }
                },

                async removeSource(platform, identifier) {
                    await fetch(`/api/sources/${platform}/${encodeURIComponent(identifier)}`, { method: 'DELETE' });
                    await this.loadSources();
                },

                async removePodcast(name) {
                    await fetch(`/api/sources/podcasts/${encodeURIComponent(name)}`, { method: 'DELETE' });
                    await this.loadSources();
                },

                async testXSummary() {
                    if (this.sources.x.length === 0) {
                        alert('Add X accounts first');
                        return;
                    }
                    this.testingX = true;
                    try {
                        const resp = await fetch('/api/llm/grok/summarize-batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                usernames: this.sources.x.slice(0, 3),
                                hours: 24
                            })
                        });
                        const data = await resp.json();
                        if (resp.ok && data.results) {
                            alert('X Summary Test:\n\n' + (data.results[0]?.combined_summary || 'No summary').substring(0, 500) + '...');
                        } else {
                            alert('Test failed: ' + (data.detail || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Network error: ' + e.message);
                    } finally {
                        this.testingX = false;
                    }
                },

                async testPodcastSummary() {
                    if (!this.testAudioUrl.trim()) {
                        alert('Enter an audio URL first');
                        return;
                    }
                    this.testingPodcast = true;
                    try {
                        const resp = await fetch('/api/llm/gemini/summarize-audio', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                audio_url: this.testAudioUrl.trim(),
                                title: 'Test Episode'
                            })
                        });
                        const data = await resp.json();
                        if (resp.ok) {
                            alert('Podcast Summary Test:\n\n' + (data.summary || 'No summary').substring(0, 500) + '...');
                        } else {
                            alert('Test failed: ' + (data.detail || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Network error: ' + e.message);
                    } finally {
                        this.testingPodcast = false;
                    }
                },

                async generateQuickBriefing() {
                    if (this.sources.x.length === 0) {
                        alert('Add X accounts first');
                        return;
                    }

                    this.generating = true;
                    this.generationError = null;
                    this.generationStep = 'Generating quick X briefing via Grok...';
                    this.generationDetail = `${this.sources.x.length} accounts, last ${this.hoursBack}h`;

                    try {
                        const resp = await fetch('/api/llm/briefing/quick', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                accounts: this.sources.x,
                                hours: parseInt(this.hoursBack),
                                focus: this.briefingFocus || null
                            })
                        });

                        const data = await resp.json();
                        if (resp.ok) {
                            // Create briefing object
                            const briefing = {
                                id: Date.now().toString(),
                                generated_at: new Date().toISOString(),
                                summary: data.summary,
                                focus: data.focus,
                                sections: [{
                                    title: 'X/Twitter Activity',
                                    platform: 'x',
                                    content: data.summary,
                                    accounts: data.accounts
                                }],
                                stats: {
                                    x_sources: data.accounts?.length || 0,
                                    x_summary_generated: true
                                }
                            };
                            this.currentBriefing = briefing;
                            this.briefings.unshift(briefing);
                        } else {
                            this.generationError = data.detail || 'Failed to generate briefing';
                        }
                    } catch (e) {
                        this.generationError = 'Network error: ' + e.message;
                    } finally {
                        this.generating = false;
                    }
                },

                async generateFullBriefing() {
                    const hasX = this.includeX && this.sources.x.length > 0;
                    const hasYT = this.includeYouTube && this.sources.youtube.length > 0;
                    const hasPodcasts = this.includePodcasts && this.sources.podcasts.length > 0;

                    if (!hasX && !hasYT && !hasPodcasts) {
                        alert('Select at least one source type with content');
                        return;
                    }

                    this.generating = true;
                    this.generationError = null;
                    this.generationStep = 'Starting briefing generation...';
                    this.generationDetail = '';

                    try {
                        // Build request
                        const requestBody = {
                            hours_back: parseInt(this.hoursBack),
                            focus: this.briefingFocus || null
                        };

                        if (hasX) requestBody.x_sources = this.sources.x;
                        if (hasYT) requestBody.youtube_sources = this.sources.youtube.map(s => s.identifier || s);
                        // Podcasts would need URLs - for now skip

                        // Update progress
                        if (hasX) {
                            this.generationStep = 'Summarizing X accounts via Grok...';
                            this.generationDetail = `${this.sources.x.length} accounts`;
                        }

                        const resp = await fetch('/api/llm/briefing', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        const data = await resp.json();
                        if (resp.ok) {
                            // Add metadata
                            data.id = Date.now().toString();
                            data.generated_at = data.stats?.generated_at || new Date().toISOString();
                            this.currentBriefing = data;
                            this.briefings.unshift(data);
                        } else {
                            this.generationError = data.detail || 'Failed to generate briefing';
                        }
                    } catch (e) {
                        this.generationError = 'Network error: ' + e.message;
                    } finally {
                        this.generating = false;
                    }
                },

                expandVideo(video) {
                    this.expandedContent = video;
                },

                expandPodcast(episode) {
                    this.expandedContent = episode;
                },

                getYouTubeThumbnail(url) {
                    if (!url) return null;
                    const match = url.match(/[?&]v=([^&]+)/) || url.match(/youtu\.be\/([^?]+)/);
                    if (match) {
                        return `https://img.youtube.com/vi/${match[1]}/mqdefault.jpg`;
                    }
                    return null;
                },

                formatMarkdown(text) {
                    if (!text) return '';
                    // Simple markdown formatting
                    return text
                        .replace(/^### (.+)$/gm, '<h3 class="text-base font-semibold mt-4 mb-2">$1</h3>')
                        .replace(/^## (.+)$/gm, '<h2 class="text-lg font-semibold mt-4 mb-2">$1</h2>')
                        .replace(/^# (.+)$/gm, '<h1 class="text-xl font-bold mt-4 mb-2">$1</h1>')
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.+?)\*/g, '<em>$1</em>')
                        .replace(/^- (.+)$/gm, '<li>$1</li>')
                        .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
                        .replace(/(<li>.*<\/li>\n?)+/g, '<ul class="list-disc ml-4 my-2">$&</ul>')
                        .replace(/\n\n/g, '</p><p class="mb-3">')
                        .replace(/\n/g, '<br>')
                        .replace(/^(.+)$/gm, function(match) {
                            if (match.startsWith('<')) return match;
                            return match;
                        });
                }
            };
        }
    </script>
</body>
</html>
